{"version":3,"sources":["file:///Users/yc/Documents/MahjongDenfense/assets/scripts/GameManager.ts"],"names":["_decorator","Component","Prefab","Sprite","SpriteFrame","instantiate","Vec3","resources","log","find","MahjongTile","ccclass","property","GameManager","tiles","gridNodes","gridNodeMap","Map","onLoad","gridsNode","children","length","loadTileSprites","then","initTiles","catch","err","Promise","resolve","reject","loadDir","frames","tileSprites","tilePrefab","i","gridNode","tile","sprite","getComponent","spriteFrame","gridWorldPos","getWorldPosition","setWorldPosition","tileScript","setGameManager","node","setGridNodes","set","push","shuffleTiles","dealTiles","j","Math","floor","random","pop","name","setParent","setPosition","ZERO","originalPosition","position"],"mappings":"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","sourcesContent":["import { _decorator, Component, Prefab, Node, Sprite, SpriteFrame, instantiate, Vec3, resources, log, find } from 'cc';\nimport { MahjongTile } from './MahjongTile';\nconst { ccclass, property } = _decorator;\n\n@ccclass('GameManager')\nexport class GameManager extends Component {\n    @property(Prefab)\n    tilePrefab: Prefab = null;\n\n    @property([SpriteFrame])\n    tileSprites: SpriteFrame[] = [];\n\n    private tiles: Node[] = [];\n    public gridNodes: Node[] = [];\n    public gridNodeMap: Map<Node, Node> = new Map();\n\n    onLoad() {\n        log('GameManager onLoad');\n\n        // 获取 Grids 节点\n        const gridsNode = find('Canvas/Grids');\n        if (gridsNode) {\n            this.gridNodes = gridsNode.children;\n            log(`Found ${this.gridNodes.length} grids`);\n        } else {\n            log('Grids node not found');\n        }\n\n        this.loadTileSprites().then(() => {\n            this.initTiles();\n        }).catch((err) => {\n            log(`Error loading tile sprites: ${err}`);\n        });\n    }\n\n    async loadTileSprites() {\n        return new Promise<void>((resolve, reject) => {\n            resources.loadDir('output', SpriteFrame, (err, frames) => {\n                if (err) {\n                    reject(err);\n                    return;\n                }\n                if (frames.length === 0) {\n                    reject('No tile sprites found');\n                    return;\n                }\n                this.tileSprites = frames;\n                log(`Loaded ${frames.length} tile sprites`);\n                resolve();\n            });\n        });\n    }\n\n    initTiles() {\n        log('Initializing tiles');\n        if (!this.tilePrefab) {\n            log('Error: tilePrefab is null');\n            return;\n        }\n\n        for (let i = 0; i < this.gridNodes.length; i++) {\n            const gridNode = this.gridNodes[i];\n\n            // 创建麻将并设置精灵\n            const tile = instantiate(this.tilePrefab);\n            const sprite = tile.getComponent(Sprite);\n            sprite.spriteFrame = this.tileSprites[i % this.tileSprites.length];\n\n            // 使用世界坐标初始化麻将的位置\n            const gridWorldPos = gridNode.getWorldPosition();\n            tile.setWorldPosition(gridWorldPos);\n\n            // 初始化 MahjongTile 脚本\n            const tileScript = tile.getComponent(MahjongTile);\n            tileScript.setGameManager(this.node);\n            tileScript.setGridNodes(this.gridNodes);\n\n            // 记录到 gridNodeMap\n            this.gridNodeMap.set(gridNode, tile);\n\n            this.tiles.push(tile);\n        }\n        this.shuffleTiles();\n        this.dealTiles();\n    }\n\n    shuffleTiles() {\n        log('Shuffling tiles');\n        for (let i = this.tiles.length - 1; i > 0; i--) {\n            const j = Math.floor(Math.random() * (i + 1));\n            [this.tiles[i], this.tiles[j]] = [this.tiles[j], this.tiles[i]];\n        }\n    }\n\n    dealTiles() {\n        log('Dealing tiles');\n        \n        for (let i = 0; i < 13; i++) {\n            let tile = this.tiles.pop();\n            const sprite = tile.getComponent(Sprite);\n            if (!tile) {\n                log(`Error: Tile is null at index ${i}`);\n                continue;\n            }\n            let gridNode = this.gridNodes[i];\n            log(`Dealing tile ${tile.getComponent(Sprite).spriteFrame.name} to grid ${gridNode.name}`);\n            tile.setParent(gridNode, true);\n            tile.setPosition(Vec3.ZERO);\n\n            // 保存每个麻将的初始位置\n            tile.getComponent(MahjongTile).originalPosition.set(tile.position);\n        }\n    }\n\n}"]}